<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>wikipedia Viewer</title>
        <style media="screen">
            body{
                box-sizing: border-box;
            }
            #main {
                background-color: violet;
                height:100%;
                width: 100%;
            }
            #search-bar {
                max-width: 30%;
                margin:auto;
                padding-top: 20%;
            }
            .inactive {
                display: none;
            }
            .active {
                display: block;
            }
            #X {
                position:relative;
                right:1.4em;
            }
            #results {
                min-height: 500px;
                max-width:500px;
                margin: auto;
            }
            #input{
                width:70px;
                transition: width 1s;
            }
            #input:focus{
                width:200px;
            }
            #ul {
                list-style-type: none;
            }
            .results-container {
                border:2px black solid;
                border-radius: 5px;
                padding: 10px;
            }
            .results-container.hidden {
                transition: all 0.4s ease-out;
                opacity: 0;
            }
            .results-container.show {
                opacity: 1;
                /* background-color: green; */
            }
            #click-span {
                text-align: center;
            }
            .mag-container {
                position: relative;
                left: 6.5em;
                padding: 10px 0;
            }
            button {
                border-radius: 30px;
                background-color: black; /* Green */
                border: none;
                color: white;
                padding: 15px 14px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin-left:5.4em;
            }
        </style>
        <!-- <script src="https://use.fontawesome.com/8f6adc7e15.js">
        </script> -->
        <script src="https://use.fontawesome.com/3978b5ff97.js"></script>
    </head>
    <body>
        <main id="main">
            <div id='search-bar'>
                <span id='click-span' class='active'>Click Search Glass:</span>
                <div class="active mag-container">
                    <i id='mag'class="fa fa-search fa-3x" aria-hidden="true"></i>
                </div>
                <div id="input-container" class="inactive">
                    <div id="input-flex">
                        <input id='input' type='text' placeholder='enter text' />
                        <span id='X'><i class="fa fa-window-close" aria-hidden="true"></i></span>
                    </div>
                </div>
                <button id='submit-button'class='btn btn2' type='button'>Search</button>
            </div>
            <div id='error-message'></div>
            <div id='results'>
                <ul id='ul'></ul>
            </div>
        </main>
        <script>
//cannot define outside
// var input = document.querySelector('#input').value;
var variable = "";
// get input
const submitButton = document.querySelector('#submit-button');
const magContainer = document.querySelector('.mag-container')
const inputContainer = document.querySelector('#input-container');
const x_button = document.querySelector('#X')
const error_message = document.querySelector('#error-message');
let input = document.querySelector('#input');
const span = document.querySelector('#click-span')


input.addEventListener('transitionend', () => {
    input.style.width = '200px'
})
magContainer.addEventListener('click',function(){
    toggle_visibility(magContainer)
    toggle_visibility(inputContainer)
    toggle_visibility(span)
})
x_button.addEventListener('click', function(){
    // if not blank, delete
    if(input.value != ""){
        removeNodes('.results-container')
        input.value = "";
    // if blank, return mag
    } else {
        toggle_visibility(inputContainer);
        toggle_visibility(magContainer);
        toggle_visibility(span);
    }
})

submitButton.addEventListener('click', (e) => {
  if((input.value === "") || (input.value === undefined)){
      // if zero messages on page, display message
    if(error_message.children.length <= 0)
        makeTextNode("Input is Empty", "p", "#error-message")
  } else if(input.value !== "") {
    variable = input.value;
    // check that input is working
      if(variable == input.value){
          // console.log('c')
          makeAjax(`${endpoint}action=query&formatversion=2&generator=prefixsearch&gpssearch=${variable}&gpslimit=10&prop=pageimages|pageterms&piprop=thumbnail&pithumbsize=50&pilimit=10&redirects=&wbptterms=description&origin=*&format=json`)
      }
  }
})
function removeNodes(className){
    var nodes = document.querySelectorAll(className)
    nodes.forEach(node => node.remove())
}
function toggle_visibility(elem) {
    if(elem.classList.contains('active')){
        elem.classList.remove('active')
        elem.classList.add('inactive')
    } else if(elem.classList.contains('inactive')){
        elem.classList.remove('inactive')
        elem.classList.add('active')
    }
}
var results = [];
function makeAjax(url){
    return fetch(url,{
      method: 'GET',
      headers: new Headers( {
          'Api-User-Agent': 'Chris Del'
      } )
    })
  .then(blob => blob.json ())
  .then((data) => {
    var pages = data.query.pages
    pages.forEach(i=> results.push(i))

    // try to loop with delay- lag on first element
    timedDisplay()

        // results.forEach((j) => {
        //     // console.log(j)
        //     var i = 1;                     //  set your counter to 1
        //     function myLoop () {           //  create a loop function
        //         setTimeout(function () {
        //             var html = makeHTML(j,'title')
        //             console.log(j)
        //             displayResults(html,'#ul')
        //             i++;                     //  increment the counter
        //             if (i < 10) {            //  if the counter < 10, call the loop function
        //                 myLoop();             //  ..  again which will trigger another
        //             }                        //  ..  setTimeout()
        //         }, 1000)
        //     }
        //     myLoop();
        // })
    // })
   })
}
// function displayResults(input,attr,node){
//     var html = input.map((i) => {
//     // console.log(i[attr])
//     var i = i[attr]
//       return `
//       <div class="results-container">
//       <li class="title node">${i}</li>
//       <a class="link node" href="https://en.wikipedia.org/wiki/${i}">https://en.wikipedia.org/wiki/${i}</a>
//       </div>
//       `
//   }).join('');
//     // return html
//     console.log(html)
//     var node = document.querySelector(node);
//     node.innerHTML = html;
// }
function timedDisplay() {
    for (var i = 0; i < 10; i++) {
        (function(i) {
            setTimeout(function() {
                var html = makeHTML(results[i],'title')
                displayResults(html,'#ul')
            },0);
        })(i);
    }
}

function displayResults(html,domNode){
    var domNode = document.querySelector(domNode);
    var div = document.querySelectorAll('.results-container');
    //
    if(div != null){
        // since first is null
        div.forEach(i => i.classList.add('show'))
    }
    // insertAdjacentHTML new api works - innerHTML does not
    domNode.insertAdjacentHTML('beforeend',html);
}
function makeHTML(input,attr){
    // console.log(i[attr])
    var input = input[attr]
      return `
      <div class="results-container hidden">
      <li class="title node">${input}</li>
      <a class="link node" href="https://en.wikipedia.org/wiki/${input}">https://en.wikipedia.org/wiki/${input}</a>
      </div>
      `
}

function makeTextNode(text, element, toAppend){
    var elem = document.createElement(element);
    var node = document.createTextNode(text)
    elem.appendChild(node)
    document.querySelector(toAppend).appendChild(elem)

}

const endpoint  = "https://en.wikipedia.org/w/api.php?"
const pageterms = "api.php?action=query&formatversion=2&prop=pageimages|pageterms&titles=Albert%20Einstein"
const search = "api.php?action=query&list=search&srsearch=Albert%20Einstein&utf8="
var generator = `action=query&formatversion=2&generator=prefixsearch&gpssearch=${variable}&gpslimit=10&prop=pageimages|pageterms&piprop=thumbnail&pithumbsize=50&pilimit=10&redirects=&wbptterms=description&origin=*&format=json`
</script>
</body>

</html>
